{% extends "layout.html" %}

{% block content %}
<div class="jumbotron">
    <h1 class="display-5">Data Forensics Analysis Tool</h1>
    <p class="lead">
        Upload your dataset to detect potential data manipulation patterns.
        This tool analyzes datasets for statistical anomalies, sorting issues, and other patterns
        that may indicate data has been manipulated.
    </p>
</div>

<div class="row">
    <div class="col-md-8 offset-md-2">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Upload a Dataset for Analysis</h5>
                <p class="card-text">
                    Supported file formats: Excel (.xlsx), CSV (.csv), Stata (.dta), SPSS (.sav)
                </p>
                
                <form action="{{ url_for('upload_file') }}" method="post" enctype="multipart/form-data" id="upload-form">
                    <div class="upload-container" id="upload-area">
                        <div class="upload-icon">
                            <i class="fas fa-file-upload"></i>
                        </div>
                        <h5>Drag & Drop your dataset file here</h5>
                        <p>or</p>
                        <input type="file" id="file" name="file" class="d-none">
                        <button type="button" class="btn btn-outline-primary" id="browse-btn">
                            <i class="fas fa-folder-open me-1"></i>Browse Files
                        </button>
                        <div id="file-name"></div>
                    </div>
                    
                    <div class="mt-3 mb-3">
                        <label class="form-label">
                            <i class="fas fa-file-pdf me-1"></i> <strong>Research Paper Context</strong> (optional)
                        </label>
                        <p class="small text-muted mb-2">Adding the original research paper helps the AI understand what to look for in your data</p>
                        <input type="hidden" name="include-paper" value="on" id="include-paper">
                    </div>
                    
                    <div id="paper-upload-area" class="upload-container mt-2 border-info" style="padding: 20px;">
                        <div class="upload-icon" style="font-size: 24px;">
                            <i class="fas fa-file-pdf"></i>
                        </div>
                        <h6>Drag & Drop research paper (PDF) here</h6>
                        <p class="small">The research paper is optional but helps provide better analysis</p>
                        <input type="file" id="paper-file" name="paper-file" class="d-none" accept=".pdf">
                        <button type="button" class="btn btn-outline-secondary btn-sm" id="browse-paper-btn">
                            <i class="fas fa-file-pdf me-1"></i>Select PDF
                        </button>
                        <div id="paper-file-name" class="mt-2"></div>
                    </div>
                    
                    <div class="text-center mt-4">
                        <button type="submit" class="btn btn-success btn-lg shadow-sm" id="analyze-btn" disabled>
                            <i class="fas fa-search me-2"></i>Analyze Data
                        </button>
                        <div class="mt-3">
                            <a href="{{ url_for('previous_results') }}" class="btn btn-outline-secondary shadow-sm">
                                <i class="fas fa-history me-1"></i>View Previous Analyses
                            </a>
                        </div>
                    </div>
                </form>
                
                <div class="loading" id="loading-indicator">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <h5 class="mt-3">Forensic Analysis in Progress</h5>
                    <div class="analysis-steps mt-3">
                        <div class="step" id="step-1">
                            <span class="badge bg-secondary step-badge">1</span>
                            <span class="step-text">Uploading and processing your Excel file</span>
                        </div>
                        <div class="step mt-2" id="step-2">
                            <span class="badge bg-secondary step-badge">2</span>
                            <span class="step-text">Analyzing data patterns and identifying suspicious observations</span>
                        </div>
                        <div class="step mt-2" id="step-3">
                            <span class="badge bg-secondary step-badge">3</span>
                            <span class="step-text">Examining Excel metadata for evidence of manipulation</span>
                        </div>
                        <div class="step mt-2" id="step-4">
                            <span class="badge bg-secondary step-badge">4</span>
                            <span class="step-text">Calculating statistical anomalies and effect sizes</span>
                        </div>
                        <div class="step mt-2" id="step-5">
                            <span class="badge bg-secondary step-badge">5</span>
                            <span class="step-text">Generating visualizations of suspicious patterns</span>
                        </div>
                        <div class="step mt-2" id="step-6">
                            <span class="badge bg-secondary step-badge">6</span>
                            <span class="step-text">Creating comprehensive forensic report with AI analysis</span>
                        </div>
                    </div>
                    <p class="mt-3">This process may take 2-3 minutes depending on file size...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row mt-5">
    <div class="col-md-4">
        <div class="card h-100">
            <div class="card-body">
                <h5 class="card-title"><i class="fas fa-search me-2"></i>Anomaly Detection</h5>
                <p class="card-text">Identifies sorting anomalies, duplicate IDs, and statistical outliers that may indicate manipulation.</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card h-100">
            <div class="card-body">
                <h5 class="card-title"><i class="fas fa-file-excel me-2"></i>Excel Metadata Analysis</h5>
                <p class="card-text">Examines Excel's internal metadata to detect evidence of row movement between conditions.</p>
            </div>
        </div>
    </div>
    <div class="col-md-4">
        <div class="card h-100">
            <div class="card-body">
                <h5 class="card-title"><i class="fas fa-chart-bar me-2"></i>Statistical Analysis</h5>
                <p class="card-text">Evaluates if suspicious observations show unusually strong effects in the expected direction.</p>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const uploadForm = document.getElementById('upload-form');
        const fileInput = document.getElementById('file');
        const browseBtn = document.getElementById('browse-btn');
        const analyzeBtn = document.getElementById('analyze-btn');
        const fileNameDisplay = document.getElementById('file-name');
        const uploadArea = document.getElementById('upload-area');
        const loadingIndicator = document.getElementById('loading-indicator');
        const steps = document.querySelectorAll('.step');
        
        // Paper upload elements
        const includePaperCheckbox = document.getElementById('include-paper');
        const paperUploadArea = document.getElementById('paper-upload-area');
        const paperFileInput = document.getElementById('paper-file');
        const browsePaperBtn = document.getElementById('browse-paper-btn');
        const paperFileNameDisplay = document.getElementById('paper-file-name');
        
        // Handle browse button click
        browseBtn.addEventListener('click', function() {
            fileInput.click();
        });
        
        // Handle file selection
        fileInput.addEventListener('change', function() {
            if (fileInput.files.length > 0) {
                fileNameDisplay.innerHTML = '<span class="badge bg-success p-2 shadow-sm mt-2">' +
                    '<i class="fas fa-check-circle me-1"></i> Selected: ' + 
                    fileInput.files[0].name + '</span>';
                analyzeBtn.disabled = false;
                uploadArea.classList.add('border-success');
            } else {
                fileNameDisplay.textContent = '';
                analyzeBtn.disabled = true;
                uploadArea.classList.remove('border-success');
            }
        });
        
        // Handle drag and drop
        uploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            uploadArea.style.backgroundColor = '#e9ecef';
        });
        
        uploadArea.addEventListener('dragleave', function() {
            uploadArea.style.backgroundColor = '#f8f9fa';
        });
        
        uploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            uploadArea.style.backgroundColor = '#f8f9fa';
            
            if (e.dataTransfer.files.length > 0) {
                fileInput.files = e.dataTransfer.files;
                fileNameDisplay.innerHTML = '<span class="badge bg-success p-2 shadow-sm mt-2">' +
                    '<i class="fas fa-check-circle me-1"></i> Selected: ' + 
                    e.dataTransfer.files[0].name + '</span>';
                analyzeBtn.disabled = false;
                uploadArea.classList.add('border-success');
            }
        });
        
        // Paper upload area is now always visible by default
        
        // Handle paper browse button click
        browsePaperBtn.addEventListener('click', function() {
            paperFileInput.click();
        });
        
        // Handle paper file selection
        paperFileInput.addEventListener('change', function() {
            if (paperFileInput.files.length > 0) {
                paperFileNameDisplay.innerHTML = '<span class="badge bg-info text-dark">' + 
                    '<i class="fas fa-file-pdf me-1"></i> Selected: ' + 
                    paperFileInput.files[0].name + '</span>';
            } else {
                paperFileNameDisplay.textContent = '';
            }
        });
        
        // Handle paper drag and drop
        paperUploadArea.addEventListener('dragover', function(e) {
            e.preventDefault();
            paperUploadArea.style.backgroundColor = '#e9ecef';
        });
        
        paperUploadArea.addEventListener('dragleave', function() {
            paperUploadArea.style.backgroundColor = '#f8f9fa';
        });
        
        paperUploadArea.addEventListener('drop', function(e) {
            e.preventDefault();
            paperUploadArea.style.backgroundColor = '#f8f9fa';
            
            if (e.dataTransfer.files.length > 0) {
                const file = e.dataTransfer.files[0];
                if (file.type === 'application/pdf') {
                    paperFileInput.files = e.dataTransfer.files;
                    paperFileNameDisplay.innerHTML = '<span class="badge bg-info text-dark">' + 
                        '<i class="fas fa-file-pdf me-1"></i> Selected: ' + 
                        file.name + '</span>';
                } else {
                    paperFileNameDisplay.innerHTML = '<span class="badge bg-danger">' + 
                        'Error: Please select a PDF file</span>';
                }
            }
        });
        
        // Show loading indicator and animate steps on form submit
        uploadForm.addEventListener('submit', function() {
            loadingIndicator.style.display = 'block';
            browseBtn.disabled = true;
            analyzeBtn.disabled = true;
            browsePaperBtn.disabled = true;
            
            // Simulate progress through the steps
            let currentStep = 0;
            
            function activateNextStep() {
                if (currentStep < steps.length) {
                    // Reset previous step if it exists
                    if (currentStep > 0) {
                        steps[currentStep-1].classList.remove('active');
                        steps[currentStep-1].querySelector('.step-badge').classList.remove('bg-primary');
                        steps[currentStep-1].querySelector('.step-badge').classList.add('bg-success');
                    }
                    
                    // Activate current step
                    steps[currentStep].classList.add('active');
                    steps[currentStep].querySelector('.step-badge').classList.remove('bg-secondary');
                    steps[currentStep].querySelector('.step-badge').classList.add('bg-primary');
                    
                    currentStep++;
                    
                    // Schedule next step
                    if (currentStep < steps.length) {
                        setTimeout(activateNextStep, getRandomTime(2000, 6000));
                    }
                }
            }
            
            function getRandomTime(min, max) {
                return Math.floor(Math.random() * (max - min + 1)) + min;
            }
            
            // Start the step animation after a short delay
            setTimeout(activateNextStep, 500);
        });
    });
</script>
{% endblock %}